name: CD - Deploy to Kubernetes on AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Login to Docker Hub
      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 3️⃣ Build Docker image (tagged with commit SHA)
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/devops-challenge:${{ github.sha }} .

      # 4️⃣ Push Docker image to Docker Hub
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/devops-challenge:${{ github.sha }}

      # 5️⃣ Deploy / Upgrade using Helm (Rolling Update)
      - name: Deploy to Kubernetes using Helm
        run: |
          helm upgrade --install devops-challenge helm/devops-challenge \
            --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/devops-challenge \
            --set image.tag=${{ github.sha }}

      # 6️⃣ Verify rollout status
      - name: Verify rollout
        run: |
          kubectl rollout status deployment devops-challenge
